{% extends "main/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Profil - {{ site_brand.title_suffix }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/profile-modern.css' %}">
{% endblock %}

{% block content %}
<section class="log-reg profile-page-root profile-modern-root" aria-label="Profile">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10 col-xl-9">
                <div class="log-reg-inner">
                    <div class="profile-brand-row">
                        <a class="profile-brand" href="{% url 'main:home' %}" aria-label="{{ site_brand.site_name }}">
                            <img src="{% static 'images/logo/mark-2026-v4.svg' %}" alt="" aria-hidden="true" decoding="async">
                            <span>{{ site_brand.site_name }}</span>
                        </a>
                        <a href="{% url 'main:home' %}" class="profile-back">
                            <i class="fas fa-chevron-left"></i> {% trans "Retour à l'accueil" %}
                        </a>
                    </div>

                    <div class="section-header inloginp">
                        <h1 class="title">{% trans "Profil" %}</h1>
                        <p class="profile-subtitle">{% trans "Gérez vos informations, votre sécurité et votre token IRC." %}</p>
                    </div>

                    <div class="main-content inloginp">
                                                {% if messages %}
                                                    {% for message in messages %}
                                                        {% if message.tags == "success" %}
                                                            <div class="alert alert-success mt-3 text-center">{{ message }}</div>
                                                        {% else %}
                                                            <div class="alert alert-danger mt-3 text-center">{{ message }}</div>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                        <!-- ✅ Only allow the profile owner to edit -->
                        {% if request.user == user_profile %}
                                                <div class="profile-grid">
                                                    <div class="profile-nav">
                                                        <div class="profile-tabs" role="tablist" aria-label="Profile tabs">
                                                            <button class="default-btn profile-tab-btn" type="button" role="tab" aria-selected="true" aria-controls="tab-profile" id="tabbtn-profile" data-tab-target="tab-profile">
                                                                <span>{% trans "Profil" %}</span>
                                                            </button>
                                                            <button class="default-btn profile-tab-btn" type="button" role="tab" aria-selected="false" aria-controls="tab-irc" id="tabbtn-irc" data-tab-target="tab-irc">
                                                                <span>{% trans "Token IRC" %}</span>
                                                            </button>
                                                            <button class="default-btn profile-tab-btn" type="button" role="tab" aria-selected="false" aria-controls="tab-account" id="tabbtn-account" data-tab-target="tab-account">
                                                                <span>{% trans "Compte" %}</span>
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <div class="profile-panels">
                                                        <!-- Profile panel: avatar + editable fields in ONE form (backend supports: avatar, gender, city, description, age) -->
                                                        <div id="tab-profile" class="profile-panel" role="tabpanel" aria-labelledby="tabbtn-profile">
                                                            <div class="profile-card">
                                                                <h2 class="profile-card-title">{% trans "Informations du profil" %}</h2>
                                                                <p class="profile-card-subtitle">{% trans "Mettez à jour votre profil public et vos informations personnelles." %}</p>

                                                                <form id="profileUpdateForm" action="{% url 'profile' username=user_profile.username %}" method="POST" enctype="multipart/form-data">
                                                                    {% csrf_token %}

                                                                    <div class="profile-hero" aria-label="Profile summary">
                                                                        <div class="profile-hero-left">
                                                                            <div class="text-center">
                                                                                {% if user_profile.avatar %}
                                                                                    {% with avatar_src=user_profile.avatar.url %}
                                                                                        <img id="selectedAvatar" src="{{ avatar_src }}" class="rounded-circle profile-avatar" alt="Avatar" data-avatar-src="{{ avatar_src }}">
                                                                                    {% endwith %}
                                                                                {% else %}
                                                                                    <img id="selectedAvatar" src="{% static 'images/default-avatar.svg' %}" class="rounded-circle profile-avatar" alt="Avatar" data-avatar-src="{% static 'images/default-avatar.svg' %}">
                                                                                {% endif %}
                                                                            </div>

                                                                            <div class="profile-hero-text">
                                                                                <div class="profile-hero-title-row">
                                                                                    <h3 class="profile-hero-name">{{ user_profile.username }}</h3>
                                                                                    {% if user_profile.email_verified %}
                                                                                        <span class="badge bg-success profile-badge">{% trans "Email vérifié" %}</span>
                                                                                    {% else %}
                                                                                        <span class="badge bg-danger profile-badge">{% trans "Email non vérifié" %}</span>
                                                                                    {% endif %}
                                                                                </div>
                                                                                <p class="profile-hero-meta">{{ user_profile.email }}</p>

                                                                                <div class="profile-avatar-picker">
                                                                                    <div class="profile-avatar-picker-row profile-avatar-picker-row-start">
                                                                                        <label for="customFile2" class="default-btn profile-secondary-btn profile-avatar-picker-label">
                                                                                            <span>{% trans "Changer la photo" %}</span>
                                                                                        </label>
                                                                                        <span id="profileAvatarFileName" class="profile-avatar-picker-filename" data-none-text="{% trans 'Aucun fichier' %}">{% trans "Aucun fichier" %}</span>
                                                                                    </div>
                                                                                    <input type="file"
                                                                                        id="customFile2"
                                                                                        name="avatar"
                                                                                        accept="image/*"
                                                                                        class="my-form-control profile-file-hidden"
                                                                                    >
                                                                                    <div class="profile-avatar-picker-hint">
                                                                                        {% trans "Sélectionnez une image puis sauvegardez." %}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>

                                                                        <div class="profile-hero-right">
                                                                            <div class="profile-hero-actions">
                                                                                <a href="{% url 'change_email' %}" class="default-btn profile-secondary-btn">
                                                                                    <span>{% trans "Modifier l'email" %}</span>
                                                                                </a>
                                                                                <a href="{% url 'change_password' %}" class="default-btn profile-secondary-btn">
                                                                                    <span>{% trans "Mot de passe" %}</span>
                                                                                </a>
                                                                                <a href="{% url 'account_settings' %}" class="default-btn profile-secondary-btn">
                                                                                    <span>{% trans "Paramètres" %}</span>
                                                                                </a>
                                                                                {% if not user_profile.email_verified %}
                                                                                    <a href="{% url 'verify_email' %}?email={{ user_profile.email|urlencode }}" class="default-btn profile-primary-btn">
                                                                                        <span>{% trans "Vérifier" %}</span>
                                                                                    </a>
                                                                                {% endif %}
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="profile-divider" role="separator" aria-hidden="true"></div>

                                                                    <div class="row">
                                                                        <div class="col-lg-6">
                                        <div class="form-group">
                                            <label>{% trans "Nom d'utilisateur" %}</label>
                                            <input type="text" class="my-form-control" value="{{ user_profile.username }}" disabled>
                                        </div>
</div>
                                        <div class="form-group">
                                            <label>{% trans "Date de naissance" %}</label>
                                            <input type="date" name="age" class="my-form-control" value="{% if user_profile.age %}{{ user_profile.age|date:'Y-m-d' }}{% endif %}">
                                        </div>

                                        <div class="form-group">
                                            <label>{% trans "Sexe" %}</label>
                                            <select name="gender" class="my-form-control">
                                                <option value="F" {% if user_profile.gender == "F" %}selected{% endif %}>{% trans "Femme" %}</option>
                                                <option value="M" {% if user_profile.gender == "M" %}selected{% endif %}>{% trans "Homme" %}</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label>{% trans "Ville" %}</label>
                                            <input type="text" name="city" class="my-form-control" value="{{ user_profile.city|default_if_none:'' }}">
                                        </div>

                                                                        </div>

                                                                        <div class="col-lg-6">
                                                                            <div class="form-group">
                                                                                <label>{% trans "À propos de moi" %}</label>
                                                                                <textarea name="description" class="my-form-control" rows="6" placeholder="{% trans 'Quelques mots sur vous…' %}">{{ user_profile.description|default_if_none:'' }}</textarea>
                                                                            </div>

                                                                            <button type="submit" class="default-btn profile-primary-btn" id="profileSaveBtn">
                                                                                <span>{% trans "Sauvegarder les modifications" %}</span>
                                                                            </button>

                                                                            <div id="profileSaveStatus" class="profile-status-space"></div>
                                                                        </div>
                                                                    </div>
                                        </form>
                                    </div>
                                </div>

                                <!-- IRC token panel -->
                                <div id="tab-irc" class="profile-panel d-none" role="tabpanel" aria-labelledby="tabbtn-irc">
                                    <div class="profile-card">
                                        <h2 class="profile-card-title">{% trans "Mot de passe IRC (token)" %}</h2>
                                        <p class="profile-card-subtitle">
                                            {% trans "Utilisez ce token comme mot de passe pour NickServ (à la place du mot de passe du site)." %}
                                            {% trans "Actifs" %}: <strong id="ircTokenActiveCount">{{ irc_app_password_count }}</strong>
                                        </p>

                                        <div id="ircTokenAlert" class="alert alert-warning" {% if not irc_app_password_plain %}style="display:none"{% endif %}>
                                            <strong>{% trans "Votre nouveau token IRC (copiez-le maintenant) :" %}</strong>
                                            <div class="profile-token-row">
                                                                    <span id="ircToken" title="{% trans 'Cliquer pour copier' %}" class="profile-inline-code profile-token-code">{{ irc_app_password_plain }}</span>
                                                <span id="ircTokenCopyStatus" class="profile-token-copy-status"></span>
                                            </div>
                                        </div>

                                        <div id="ircTokenActionStatus" class="profile-status-space"></div>

                                        <div class="profile-actions-row sidebar-links">
                                            <form id="ircTokenGenerateForm" method="POST" action="{% url 'generate_irc_app_password' username=user_profile.username %}">
                                                {% csrf_token %}
                                                <button type="submit" class="default-btn profile-secondary-btn">{% trans "Générer un token IRC" %}</button>
                                            </form>
                                            <form id="ircTokenRevokeForm" method="POST" action="{% url 'revoke_irc_app_password' username=user_profile.username %}">
                                                {% csrf_token %}
                                                <button type="submit" class="default-btn profile-secondary-btn text-danger">{% trans "Révoquer le token IRC" %}</button>
                                            </form>
                                        </div>

                                        <p class="profile-example">
                                            {% trans "Exemple" %}: <span class="profile-inline-code">/msg NickServ IDENTIFY {{ user_profile.username }} &lt;token&gt;</span>
                                        </p>
                                    </div>
                                </div>

                                <!-- Account panel -->
                                <div id="tab-account" class="profile-panel d-none" role="tabpanel" aria-labelledby="tabbtn-account">
                                    <div class="profile-card">
                                        <h2 class="profile-card-title">{% trans "Compte" %}</h2>
                                        <p class="profile-card-subtitle">{% trans "Sécurité, paramètres et gestion du compte." %}</p>

                                        <div class="sidebar-links profile-account-links">
                                            <a href="{% url 'account_settings' %}" class="default-btn profile-secondary-btn">{% trans "Paramètres du compte" %}</a>
                                            <a href="{% url 'change_password' %}" class="default-btn profile-secondary-btn">{% trans "Modifier le mot de passe" %}</a>
                                            <a href="{% url 'forgot_password' %}?email={{ user_profile.email|urlencode }}" class="default-btn profile-secondary-btn">{% trans "Réinitialiser le mot de passe par email" %}</a>
                                            <a href="{% url 'delete_account' %}" class="default-btn profile-secondary-btn text-danger">{% trans "Supprimer mon compte" %}</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% else %}
                        <div class="profile-empty-state" role="alert" aria-live="polite">
                            <div class="profile-empty-title">{% trans "Accès refusé" %}</div>
                            <p class="profile-empty-text">{% trans "Vous n'avez pas la permission d'accéder à ce profil." %}</p>
                            <div class="profile-empty-actions">
                                <a href="{% url 'main:home' %}" class="default-btn profile-secondary-btn">
                                    <span>{% trans "Retour à l'accueil" %}</span>
                                </a>
                                <a href="{% url 'login' %}" class="default-btn profile-primary-btn">
                                    <span>{% trans "Se connecter" %}</span>
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script nonce="{{ request.csp_nonce }}" src="{% static 'js/profile-modern.js' %}" defer></script>

{% endblock %}
