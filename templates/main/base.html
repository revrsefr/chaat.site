{% load static i18n %}
{% get_current_language as CURRENT_LANGUAGE %}
<!DOCTYPE html>
<html lang="{{ CURRENT_LANGUAGE|default:'fr' }}" data-cmp-enabled="{{ cmp_enabled|yesno:'1,0' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Rejoignez dès maintenant votre tchat gratuit sans inscription et discuter avec des milliers d'utilisateurs sur le tchatche. Rencontre amicale gratuit sans inscription chez tchatzone!">
    <meta name="classification" content="Internet, Chat, Communaute, Portail, Services, Chat, Rencontres">
    <meta name="type" content="chat">
    <meta name="robots" content="index, follow">
    <meta name="distribution" content="global">
    <meta name="identifier-url" content="{{ site_brand.base_url }}/">
    <meta name="rating" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="keywords" content="chat en ligne, discussion instantanée, tchat gratuit, rencontres, chat sans inscription">
    <meta name="author" content="{{ site_brand.meta_author }}">
    <link rel="apple-touch-icon" sizes="120x120" href="{% static 'images/apple-touch-icon-120x120-precomposed.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'images/apple-touch-icon-152x152-precomposed.png' %}">
    <meta property="og:title" content="Rejoignez dès maintenant votre tchat gratuit sans inscription et discuter avec des milliers d'utilisateurs du monde entier. bon tchatche sur votre site de discussion !">
    <meta property="og:description" content="Rejoignez notre chat gratuit pour discuter en direct avec de nouvelles personnes. Aucune inscription requise !">
    <meta property="og:image" content="{{ site_brand.base_url }}{% static 'images/banner/shape/home3/01.png' %}">
    <meta property="og:url" content="{{ canonical_url }}">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="{{ site_brand.site_name }}">
    <meta property="og:locale" content="fr_FR">
    <link rel="canonical" href="{{ canonical_url }}">

    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@graph": [
                {
                    "@type": "WebSite",
                    "@id": "{{ site_brand.base_url }}/#website",
                    "url": "{{ site_brand.base_url }}/",
                    "name": "{{ site_brand.site_name|escapejs }}"
                },
                {
                    "@type": "Organization",
                    "@id": "{{ site_brand.base_url }}/#organization",
                    "url": "{{ site_brand.base_url }}/",
                    "name": "{{ site_brand.site_name|escapejs }}"
                },
                {
                    "@type": "WebPage",
                    "@id": "{{ canonical_url }}#webpage",
                    "url": "{{ canonical_url }}",
                    "name": "{{ site_brand.site_name|escapejs }}",
                    "isPartOf": {"@id": "{{ site_brand.base_url }}/#website"}
                }
            ]
        }
    </script>


    <title>{% block title %}{{ site_brand.default_title }}{% endblock %}</title>
    
    <!-- Stylesheets: load non-blocking to improve mobile LCP -->
    <style>
        /* Minimal critical paint (avoid stark FOUC while main CSS loads) */
        html, body { margin: 0; padding: 0; }
        body { font-family: "Public Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
    </style>

    <style>
        /* Ensure icon text remains visible while fonts load (Lighthouse: font-display). */
        @font-face {
            font-family: bootstrap-icons;
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src:
                url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/fonts/bootstrap-icons.woff2?dd67030699838ea613ee6dbda90effa6") format("woff2"),
                url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/fonts/bootstrap-icons.woff?dd67030699838ea613ee6dbda90effa6") format("woff");
        }
    </style>

    <link rel="preload" as="style" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">

    <link rel="preload" as="style" href="{% static 'css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/all.min.css' %}">

    <!-- Non-critical CSS (already deferred) -->
    <link rel="preload" as="style" href="{% static 'css/animate.css' %}">
    <link rel="stylesheet" href="{% static 'css/animate.css' %}">

    <link rel="preload" as="style" href="{% static 'css/style.css' %}?v={{ static_version }}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v={{ static_version }}">

    <link rel="preload" as="style" href="{% static 'css/header-modern.css' %}?v={{ static_version }}">
    <link rel="stylesheet" href="{% static 'css/header-modern.css' %}?v={{ static_version }}">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="preload" as="style" href="{% static 'css/font-display-overrides.css' %}?v={{ static_version }}">
    <link rel="stylesheet" href="{% static 'css/font-display-overrides.css' %}?v={{ static_version }}">
    <link rel="icon" href="{% static 'images/favicon.ico' %}" sizes="any">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon-16x16.png' %}">
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">

    {% if not cmp_enabled %}
    <!-- Cookie consent UI styles (professional, informative, accessible) -->
    <link rel="preload" as="style" href="{% static 'css/cookie-consent.css' %}?v={{ static_version }}">
    <link rel="stylesheet" href="{% static 'css/cookie-consent.css' %}?v={{ static_version }}">
    {% endif %}

    {% if cmp_enabled and google_fc_publisher_id %}
    <!-- IAB TCF CMP (Google Funding Choices) -->
    <script async src="https://fundingchoicesmessages.google.com/i/{{ google_fc_publisher_id }}?ers=1"></script>
    {% endif %}

    <!-- Google Consent Mode v2 (for GTM) -->
    <script nonce="{{ request.csp_nonce }}" data-cookieconsent="ignore">
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }

        // Default to DENIED until the user makes an explicit choice.
        // The cookie-consent UI will call gtag('consent','update', ...) after selection.
        gtag('consent', 'default', {
            'ad_personalization': 'denied',
            'ad_storage': 'denied',
            'ad_user_data': 'denied',
            'analytics_storage': 'denied',
            'functionality_storage': 'denied',
            'personalization_storage': 'denied',
            'security_storage': 'granted',
            'wait_for_update': 500,
        });

        gtag('set', 'ads_data_redaction', true);
        gtag('set', 'url_passthrough', false);

        // Load GTM only after consent.
        (function () {
            var loaded = false;

            function loadGTMOnce() {
                if (loaded) return;
                loaded = true;
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });

                var script = document.createElement('script');
                script.async = true;
                script.src = 'https://www.googletagmanager.com/gtm.js?id=GTM-5J4F54MR';
                script.nonce = "{{ request.csp_nonce }}";
                var first = document.getElementsByTagName('script')[0];
                first.parentNode.insertBefore(script, first);
            }

            function updateFromTCF(tcData) {
                // Conservative mapping from TCF purposes to Google Consent Mode.
                // Purpose 1 (Store and/or access information on a device) gates any storage.
                var canStore = !!(tcData && tcData.purpose && tcData.purpose.consents && tcData.purpose.consents[1]);

                var p = (tcData && tcData.purpose && tcData.purpose.consents) ? tcData.purpose.consents : {};
                var analytics = canStore && (!!p[8] || !!p[9] || !!p[10]);
                var advertising = canStore && (!!p[2] || !!p[3] || !!p[4] || !!p[7]);

                if (typeof window.gtag === 'function') {
                    window.gtag('consent', 'update', {
                        analytics_storage: analytics ? 'granted' : 'denied',
                        ad_storage: advertising ? 'granted' : 'denied',
                        ad_user_data: advertising ? 'granted' : 'denied',
                        ad_personalization: (canStore && (!!p[3] || !!p[4])) ? 'granted' : 'denied',
                        functionality_storage: canStore ? 'granted' : 'denied',
                        personalization_storage: (canStore && (!!p[5] || !!p[6])) ? 'granted' : 'denied',
                        security_storage: 'granted'
                    });
                }

                if (analytics || advertising) {
                    loadGTMOnce();
                }
            }

            // Keep the <script> free of Django template syntax for editor/linters.
            var cmpEnabled = document.documentElement.getAttribute('data-cmp-enabled') === '1';

            if (cmpEnabled) {
                // TCF CMP mode: react to consent changes via __tcfapi.
                if (typeof window.__tcfapi === 'function') {
                    window.__tcfapi('addEventListener', 2, function (tcData, success) {
                        if (!success) return;
                        if (!tcData) return;
                        // Only act when the CMP has a usable signal.
                        if (tcData.eventStatus === 'tcloaded' || tcData.eventStatus === 'useractioncomplete') {
                            updateFromTCF(tcData);
                        }
                    });
                }
            } else {
                // Custom banner mode: load GTM only if the user consented via first-party cookies.
                function getCookie(name) {
                    var match = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'));
                    return match ? decodeURIComponent(match[1]) : '';
                }

                window.__loadGTMIfConsented = function () {
                    // Require explicit consent on at least one tracking category.
                    var analytics = getCookie('cookie_analytics') === 'yes';
                    var advertising = getCookie('cookie_advertising') === 'yes';
                    if (!analytics && !advertising) return;
                    loadGTMOnce();
                };

                // Attempt immediately for returning users (cookie already set).
                window.__loadGTMIfConsented();
            }
        })();
    </script>

    <!-- Google Fonts (defer CSS to reduce render blocking) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap">
    {% block head %}{% endblock %}
</head>
<body>   

    <div style="display:none">{% csrf_token %}</div>

    {% if not cmp_enabled %}
        {% if request.COOKIES.cookie_analytics == 'yes' or request.COOKIES.cookie_advertising == 'yes' %}
        <!-- Google Tag Manager (noscript) - only for users who already consented -->
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5J4F54MR"
        height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
        <!-- End Google Tag Manager (noscript) -->
        {% endif %}
    {% endif %}
    {% include 'main/header.html' %}

    
        {% block content %}
        
        
        {% endblock %}
   

    {% include 'main/footer.html' %}

    {% if not cmp_enabled %}
    {% include "main/partials/cookie-consent.html" %}
    {% endif %}

    {% block scripts %}
    
    <script nonce="{{ request.csp_nonce }}" defer src="{% static 'js/vendor/jquery-3.6.0.min.js' %}"></script>
    <script nonce="{{ request.csp_nonce }}" defer src="{% static 'js/vendor/modernizr-3.11.2.min.js' %}"></script>

    {# Page-specific vendor libs that must load AFTER jQuery and BEFORE main.js #}
    {% block page_vendor_scripts %}{% endblock %}

    <script nonce="{{ request.csp_nonce }}" defer src="{% static 'js/vendor/bootstrap.bundle.min.js' %}"></script>
    <script nonce="{{ request.csp_nonce }}" defer src="{% static 'js/plugins.js' %}"></script>
    <script nonce="{{ request.csp_nonce }}" defer src="{% static 'js/img-fallback.js' %}?v={{ static_version }}"></script>
    <script nonce="{{ request.csp_nonce }}" defer src="{% static 'js/confirm.js' %}?v={{ static_version }}"></script>
    <script nonce="{{ request.csp_nonce }}" defer src="{% static 'js/main.js' %}?v={{ static_version }}"></script>

    {# Page-specific scripts that can load after main.js #}
    {% block page_scripts %}{% endblock %}

    {% if not cmp_enabled %}
    <!-- Cookie consent logic -->
    <script nonce="{{ request.csp_nonce }}" defer src="https://cdn.jsdelivr.net/npm/js-cookie@3/dist/js.cookie.min.js"></script>
    <script nonce="{{ request.csp_nonce }}" defer src="{% static 'js/cookie-consent.js' %}?v={{ static_version }}&cb=20260116"></script>
    {% endif %}
    
    <script nonce="{{ request.csp_nonce }}">
        (function() {
            function fetchUserCount() {
                var currentEl = document.querySelector(".counter");
                if (!currentEl) return;

                fetch(window.location.href, { headers: { "X-Requested-With": "XMLHttpRequest" } })
                    .then(function(response) { return response.text(); })
                    .then(function(html) {
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(html, "text/html");
                        var newEl = doc.querySelector(".counter");
                        if (!newEl) return;
                        currentEl.innerText = newEl.innerText;
                    })
                    .catch(function() {
                        // Ignore (page might block XHR, offline, or no counter on response)
                    });
            }

            // ✅ Only run on pages that have the counter
            if (document.querySelector(".counter")) {
                setInterval(fetchUserCount, 5000);
            }
        })();
    </script>
                  
    {% endblock %}
</body>
</html>