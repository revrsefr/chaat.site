{% extends "main/base.html" %}
{% load static i18n %}

{% block title %}{% trans "Report a user" %} - {{ site_brand.title_suffix }}{% endblock %}

{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap">
<link rel="stylesheet" href="{% static 'css/report-modern.css' %}">
{% endblock %}

{% block content %}
<section class="log-reg report-page-root" aria-label="Report a user">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-7 col-xl-6">
                <div class="log-reg-inner report-card">
                    <div class="report-hero">
                        <div class="report-hero-icon" aria-hidden="true">
                            <i class="fa-solid fa-flag"></i>
                        </div>
                        <div>
                            <h3 class="title">{% trans "Report a user" %}</h3>
                            <p class="login-subtitle">{% trans "Send a report to the staff team." %}</p>
                        </div>
                    </div>

                    <div class="report-note">
                        <p>{% trans "Please describe what happened and include any useful context (nicknames, channel, time)." %}</p>
                    </div>

                    {% if messages %}
                        <div class="alert alert-success report-alert" role="alert" aria-live="polite">
                            {% for message in messages %}{{ message }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                        </div>
                    {% endif %}

                    {% if form.non_field_errors %}
                        <div class="alert alert-danger report-alert" role="alert" aria-live="polite">
                            {{ form.non_field_errors|striptags }}
                        </div>
                    {% endif %}

                    <form method="post" novalidate class="report-form">
                        {% csrf_token %}
                        <div class="report-grid">
                            <div class="form-group">
                                <label for="id_reported_username">{% trans "User reported" %}</label>
                                <input type="text" name="reported_username" id="id_reported_username" class="my-form-control" value="{{ form.reported_username.value|default_if_none:'' }}" placeholder="{% trans "e.g. Alex42" %}" required>
                                {% if form.reported_username.errors %}
                                    <div class="field-error" role="alert">{{ form.reported_username.errors|striptags }}</div>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                <label for="id_motive">{% trans "Motif" %}</label>
                                <textarea name="motive" id="id_motive" class="my-form-control" rows="6" placeholder="{% trans "What happened?" %}" required>{{ form.motive.value|default_if_none:'' }}</textarea>
                                {% if form.motive.errors %}
                                    <div class="field-error" role="alert">{{ form.motive.errors|striptags }}</div>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                <label>{% trans "Security check" %}</label>
                                <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_key }}"></div>
                                <div class="field-error recaptcha-error" id="recaptchaError" role="alert" aria-live="polite"></div>
                            </div>
                        </div>

                        <div class="report-actions">
                            <button type="submit" class="default-btn report-submit">
                                <span>{% trans "Send report" %}</span>
                            </button>
                            <span class="report-footnote">{% trans "Reports are reviewed by staff and kept confidential." %}</span>
                        </div>
                    </form>
                    <script nonce="{{ request.csp_nonce }}" src="https://www.google.com/recaptcha/api.js" async defer></script>
                    <script nonce="{{ request.csp_nonce }}">
                        (function() {
                            var form = document.querySelector('.report-form');
                            var errorEl = document.getElementById('recaptchaError');
                            if (!form || !errorEl) return;

                            form.addEventListener('submit', function(event) {
                                var response = '';
                                if (window.grecaptcha && typeof window.grecaptcha.getResponse === 'function') {
                                    response = window.grecaptcha.getResponse();
                                }

                                if (!response) {
                                    event.preventDefault();
                                    errorEl.textContent = "{% trans 'Please complete the reCAPTCHA.' %}";
                                    errorEl.classList.add('is-visible');
                                } else {
                                    errorEl.textContent = '';
                                    errorEl.classList.remove('is-visible');
                                }
                            });
                        })();
                    </script>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
