{% extends "main/base.html" %}

{% block title %}IRCd - Vérification reCAPTCHA{% endblock %}

{% block head %}
{{ block.super }}
{% include "recaptcha/_theme.html" %}
{% endblock %}

{% block content %}
<main class="recaptcha-ui">
    <div class="recaptcha-ui__wrap">
        <div class="recaptcha-ui__card">
            <header class="recaptcha-ui__header">
                <p class="recaptcha-ui__eyebrow">Vérification de sécurité</p>
                <h1 class="recaptcha-ui__title">IRCd - Google reCAPTCHA</h1>
                <p class="recaptcha-ui__subtitle">Complétez le challenge, puis copiez/collez la commande dans IRC pour terminer.</p>
            </header>

            <form id="recaptcha-form" action="{% url 'recaptcha:process_recaptcha' %}" method="POST" onsubmit="submitForm(event)">
                {% csrf_token %}
                <input type="hidden" name="jwt" value="{{ jwt }}">
                <input type="hidden" name="mode" value="jwt">

                <div class="recaptcha-ui__recaptcha">
                    <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
                </div>

                <div class="recaptcha-ui__actions">
                    <button type="submit" class="recaptcha-ui__button recaptcha-ui__button--primary">Vérifier</button>
                    <a href="{% url 'main:home' %}" class="recaptcha-ui__button recaptcha-ui__button--secondary">Retour à l’accueil</a>
                </div>
            </form>

            <div id="message-container"></div>

            <div id="token-container" class="recaptcha-ui__token d-none">
                <h4 class="alert-heading">Vérification réussie&nbsp;!</h4>
                <p>Utilisez cette commande dans IRC pour finaliser votre vérification&nbsp;:</p>
                <pre><code id="verification-token"></code></pre>
                <div class="recaptcha-ui__actions" style="margin-top: 1rem;">
                    <button type="button" class="recaptcha-ui__button recaptcha-ui__button--primary" onclick="copyToClipboard()">Copier</button>
                </div>
            </div>

            <p class="recaptcha-ui__hint"><strong>Besoin d’aide&nbsp;?</strong> Rejoignez <code>#!aide</code> sur IRC.</p>
        </div>
    </div>

    <script>
        // Utility function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        function submitForm(event) {
            event.preventDefault(); // Prevent the default form submission
        
            const recaptchaResponse = document.querySelector('.g-recaptcha-response').value;
            const form = event.target;
        
            if (!recaptchaResponse) {
                displayMessage('Merci de compléter le reCAPTCHA.', 'alert-danger');
                return;
            }
        
            const formData = new FormData(form);
            formData.append('g-recaptcha-response', recaptchaResponse);
        
            // Send the reCAPTCHA response and session details to the server
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'), // Add CSRF token from the cookies
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "ok") {
                        // Display the verification token
                        document.getElementById("token-container").classList.remove("d-none");
                        document.getElementById("verification-token").textContent = `/verify ${data.result}`;
                    } else {
                        // Display error message
                        displayMessage(data.message || "Une erreur est survenue.", 'alert-danger');
                        grecaptcha.reset(); // Reset the reCAPTCHA
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    displayMessage('Une erreur est survenue. Veuillez réessayer.', 'alert-danger');
                });
        }        
    
        function displayMessage(message, alertType) {
            const messageContainer = document.getElementById('message-container');
            messageContainer.innerHTML = `<div class="alert ${alertType}" role="alert">${message}</div>`;
        }

        function copyToClipboard() {
            const token = document.getElementById("verification-token").textContent;
            navigator.clipboard.writeText(token).then(() => {
                displayMessage('Copié&nbsp;!', 'alert-success');
            }, () => {
                displayMessage('Impossible de copier automatiquement. Copiez manuellement.', 'alert-danger');
            });
        }
    </script>

</main>
{% endblock %}
