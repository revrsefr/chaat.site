{% extends "main/base.html" %}

{% block title %}chaat.site - Vérification reCAPTCHA IRC{% endblock %}

{% block head %}
{{ block.super }}
{% include "recaptcha/_theme.html" %}
{% endblock %}

{% block content %}
<main class="recaptcha-ui">
    <div class="recaptcha-ui__wrap">
        <div class="recaptcha-ui__card">
            <header class="recaptcha-ui__header">
                <p class="recaptcha-ui__eyebrow">Vérification de sécurité</p>
                <h1 class="recaptcha-ui__title">chaat.site — reCAPTCHA IRC</h1>
                <p class="recaptcha-ui__subtitle">Complétez le reCAPTCHA, puis utilisez la commande dans IRC pour terminer.</p>
            </header>

            <form id="recaptcha-form" method="POST" onsubmit="submitForm(event)">
                {% csrf_token %}
                <input type="hidden" name="code" value="{{ code }}">
                <input type="hidden" name="hn" value="{{ hn }}">

                <div class="recaptcha-ui__recaptcha">
                    <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
                </div>

                <div class="recaptcha-ui__actions">
                    <button type="submit" class="recaptcha-ui__button recaptcha-ui__button--primary">Vérifier</button>
                    <a href="{% url 'main:home' %}" class="recaptcha-ui__button recaptcha-ui__button--secondary">Retour à l’accueil</a>
                </div>
            </form>

            <div id="message-container"></div>

            <div id="token-container" class="recaptcha-ui__token d-none">
                <h4 class="alert-heading">Vérification réussie&nbsp;!</h4>
                <p>Utilisez cette commande dans IRC pour finaliser votre vérification&nbsp;:</p>
                <pre><code id="verification-token"></code></pre>
            </div>

            <p class="recaptcha-ui__hint"><strong>Besoin d’aide&nbsp;?</strong> Rejoignez <code>#!aide</code> sur IRC.</p>
        </div>
    </div>

    <script>
        function submitForm(event) {
            event.preventDefault(); // Prevent the default form submission

            const recaptchaResponse = document.querySelector('.g-recaptcha-response').value;
            const code = document.querySelector('input[name="code"]').value;
            const hn = document.querySelector('input[name="hn"]').value;

            if (!recaptchaResponse) {
                displayMessage('Merci de compléter le reCAPTCHA.', 'alert-danger');
                return;
            }

            // Send the reCAPTCHA response and session details to the server
            fetch('/process-recaptcha/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Add CSRF token
                },
                body: JSON.stringify({
                    code: code,
                    hn: hn,
                    'g-recaptcha-response': recaptchaResponse
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "ok") {
                    // Display the verification token
                    document.getElementById("token-container").classList.remove("d-none");
                    document.getElementById("verification-token").textContent = `/verificar ${data.result}`;
                } else {
                    // Display error message
                    displayMessage(data.message || "Une erreur est survenue.", 'alert-danger');
                    grecaptcha.reset(); // Reset the reCAPTCHA
                }
            })
            .catch(error => {
                console.error('Error:', error);
                displayMessage('Une erreur est survenue. Veuillez réessayer.', 'alert-danger');
            });
        }

        function displayMessage(message, alertType) {
            const messageContainer = document.getElementById('message-container');
            messageContainer.innerHTML = `<div class="alert ${alertType}" role="alert">${message}</div>`;
        }

        // Utility function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

</main>
{% endblock %}
